<script>
// Builds the drop-down of Jobreels for that user.
// This should also set the active jobreel to whichever is selected. Default profile?
  $(function() {
    $.get("/jobreels").success( function( data ) {
      var htmlString = "";
      $.each(data, function(index,  jobreel) {
        console.log(jobreel);
        var liElement = '<span id="jobreel-id-' +
        jobreel.id +
        '">Jobreel: ' +
        jobreel.job_title +
        '</span>';
        htmlString += liElement;
        console.log(htmlString);
      });
      var ulJobreels = $('.dropdown-content');
      ulJobreels.html(htmlString);
    });
  });
</script>

<script>
// This grabs the public IDs of the selected videos and inserts the posters into the workspace
  var selectedVideos = [];
  function selectVideo(element){
    var publicID = element.childNodes[0].alt;
    var versionID = element.childNodes[0].src;
    var posterSrc = element.childNodes[0].src;
    selectedVideos.push(publicID);

    $('#insertion-point').prepend('<img src="'+posterSrc+'" width = "188" height = "104"></img>')
    $('#selectModal').modal('hide');
    event.preventDefault();
  }
</script>

<script>
// This should update the current jobreel with the selectedVideos for the appropriate section
  function pushVideos(){
    alert('pushing next');
    $.post("/jobreels/" + <%= @jobreel.id %>, {
      _method: "PATCH",
      jobreel: {
        section1_videos: selectedVideos
      }
    });
  }
  // figure out success handler to update the various DOM elements
</script>

<!-- Video Selection Modal -->
<div class="modal fade bd-example-modal-lg" id="selectModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Select a Video to Add</h4>
      </div>
      <div class="modal-body">
        <% if @intro_videos.present? %>
        <% @intro_videos.each do |disp| %>
          <a href="#" onclick="selectVideo(this)"><%= cl_image_tag(disp.cloud_video.public_id + ".jpg", :resource_type => "video", :version => disp.cloud_video.stored_version, :transformation => { :width => 100, :height => 72, :crop => :fill }) %></a>
          <% end %>
        <% else %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<!-- End Modal -->

<!-- Video Edit Modal -->
<div class="modal fade bd-example-modal-sm" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Edit User Info</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <%= simple_form_for @video_new do |f| %>
            <%= f.input :video_section, collection: ["Introduction", "Education", "Work Experience", "Hobbies", "Recommendations"], label: "Video Section", :include_blank => false %>
            <%= f.input :cloud_video %>
            <%= f.submit 'Update', class: 'btn btn-primary' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Modal -->

<div class="container-fluid">
  <div class="row studio-bar">
    <div class="col-6 offset-1 studio-top">
    <h1>JobReel Studio</h1>
    <h3>Build your JobReel below. First, upload the videos that you'd like to use for each section in the left column and then, click and drag them to build your timeline below, one section at a time.</h3>
  </div>
<div class="col-2">&nbsp</div>
<div class="col-2 align-self-center">

          <button type="button" class='upload-button' data-toggle="modal" data-target="#uploadModal">+&nbsp&nbsp&nbspUPLOAD VIDEO</button>
  </div>
</div>
</div>

<div class="row studio-body justify-content-center">
  <div class="col-3">
  <div class="card vid-library padded5">
    <div class="card-block"> <!--Library Navigation Block-->
<div class="row nopadding">
  <div class="col-10 vid-library-top">
    <div class="dropdown">
    <button onclick="myFunction()" class="dropbtn">Current Jobreel - Job.title</button>
      <div id="myDropdown" class="dropdown-content">
      </div>
    </div>
  </div>
  <div class="col-2 text-center vert-align side-border">
    +
  </div>
</div>
</div>

<div class="card-block white">
  <div class="row vid-library-body-first">
    <div class="col-2 nopadding text-center">
    <%= image_tag 'intro-icon-lg.png' %>
  </div>
  <div class="col-9 vert-align padded7">
    <span id = "intro_collapse">Introduction</span>
  </div>

  <br /><br />
  <div id = "intro_hidden" class="col-10 offset-1 poster-display">
    <% if @intro_videos.present? %>
    <% @intro_videos.each do |disp| %>
      <%= cl_image_tag(disp.cloud_video.public_id + ".jpg", :resource_type => "video", :version => disp.cloud_video.stored_version, :transformation => { :width => 100, :height => 72, :crop => :fill }) %>
      <% end %>
    <% else %>
    <% end %>

      <%= image_tag "upload-video.png", data: {toggle: 'modal', target: '#uploadModal'} %>

  </div>
  </div>
  <hr>
  <div class="row vid-library-body">
    <div class="col-2 nopadding text-center">
    <%= image_tag 'education-icon-lg.png', id:"edu_icon" %>
  </div>
  <div class="col-9 vert-align padded7">
    <span id = "edu_collapse">Education</span>
</div>
  <br /><br />
  <div id ="edu_hidden" class="col-10 offset-1 poster-display" style="display: none;">
    <% if @education_videos.present? %>
    <% @education_videos.each do |disp| %>
      <%= cl_image_tag(disp.cloud_video.public_id + ".jpg", :resource_type => "video", :version => disp.cloud_video.stored_version, :transformation => { :width => 100, :height => 72, :crop => :fill }) %>
      <% end %>
    <% else %>
    <% end %>

      <%= image_tag "upload-video.png", data: {toggle: 'modal', target: '#uploadModal'} %>

  </div>
  </div>
    <hr>
  <div class="row vid-library-body">
    <div class="col-2 nopadding text-center">
    <%= image_tag 'work-icon-lg.png' %>
  </div>
  <div class="col-9 vert-align padded7">
    <span id="work_collapse">Work Experience</span>
</div>
  <br /><br />
  <div id="work_hidden" class="col-10 offset-1 poster-display" style="display: none;">
    <% if @work_videos.present? %>
    <% @work_videos.each do |disp| %>
      <%= cl_image_tag(disp.cloud_video.public_id + ".jpg", :resource_type => "video", :version => disp.cloud_video.stored_version, :transformation => { :width => 100, :height => 72, :crop => :fill }) %>
      <% end %>
    <% else %>
    <% end %>

      <%= image_tag "upload-video.png", data: {toggle: 'modal', target: '#uploadModal'} %>

  </div>
  </div>
    <hr>
  <div class="row vid-library-body">
    <div class="col-2 nopadding text-center">
    <%= image_tag 'hobbies-icon-lg.png' %>
  </div>
  <div class="col-9 vert-align padded7">
    <span id="hobby_collapse">Hobbies</span>
</div>
  <br /><br />
  <div id="hobby_hidden" class="col-10 offset-1 poster-display" style="display: none;">
    <% if @hobby_videos.present? %>
    <% @hobby_videos.each do |disp| %>
      <%= cl_image_tag(disp.cloud_video.public_id + ".jpg", :resource_type => "video", :version => disp.cloud_video.stored_version, :transformation => { :width => 100, :height => 72, :crop => :fill }) %>
      <% end %>
    <% else %>
    <% end %>

      <%= image_tag "upload-video.png", data: {toggle: 'modal', target: '#uploadModal'} %>

  </div>
  </div>
    <hr>
  <div class="row vid-library-body-last">
    <div class="col-2 nopadding text-center">
    <%= image_tag 'recs-icon-lg.png' %>
  </div>
  <div class="col-9 vert-align padded7">
    <span id="rec_collapse">Recommendations</span>
</div>
  <br /><br />
  <div id = "rec_hidden" class="col-10 offset-1 poster-display" style="display: none;">
    <% if @rec_videos.present? %>
    <% @rec_videos.each do |disp| %>
      <%= cl_image_tag(disp.cloud_video.public_id + ".jpg", :resource_type => "video", :version => disp.cloud_video.stored_version, :transformation => { :width => 100, :height => 72, :crop => :fill }) %>
      <% end %>
    <% else %>
    <% end %>

      <%= image_tag "upload-video.png", data: {toggle: 'modal', target: '#uploadModal'} %>

  </div>
  </div>
</div>
</div> <!--End of Video Library Card -->
</div>

<div class="col-5">
<div class="card studio-player nopadding">
    <div class="card-block studio-blend nopadding">
      <!-- <%= image_tag 'video-player-lg.png' %> -->
      <% if current_user.video.present? %>
        <%= cl_video_tag(@intro_videos.first.private_id, controls: true, transformation: @overlays) %>
      <% end %>
    </div>
</div>
<div class="card studio-timeline padded5">
  <div class="card-block white timeline-bot-bar">
    <div class="row justify-content-between">
    <h1 class="vert-align">Introduction</h1>
    <button class="add-button">Preview</button>
    <!-- This needs to update the current jobreel with the selectedVideos as params -->
    <%= link_to 'Save', '#', id: "push-button", class: "add-button" %>
  </div>
  </div>
  <div class="card-block white timeline-instructions">
    <h3>From the left column where you've uploaded your videos, drag the ones you'd like to show viewers in the space provided below in the order you'd like them to appear.</h3>

  </div>
  <div class="card-block white timeline-workspace">
    <div class="row">
          <div class="col-4 text-center">
            <%= image_tag 'empty-frame.png', data: {toggle: 'modal', target: '#selectModal'}%>
          </div>
          <div class="col-8 no-pad-left">
            <div class="slider">
              <div class="scroll-left" id ="left1">&lt;
              </div>
              <div class="scroll-right" id="right1">&gt;
              </div>
              <div class="track" id="insertion-point">
              </div>
            </div>
          </div>
    </div>
  </div>
</div>

</div>

<script>
/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
}

// Close the dropdown if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {

    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}
</script>

<script>
// This controls the netflix-style scrolling div
setInterval(function() {
    var left1 = parseInt($('#insertion-point').css('left'));

    if ($('#left1').is(":hover")) {
        $('#insertion-point').css('left', left1+2);
    }
    else if ($('#right1').is(":hover")) {
        $('#insertion-point').css('left', left1-2);
    }
}, 10);
</script>

<script>
// This controls the collapsing sections and the click handler for the push-button to update public IDs with selected videos
$(document).ready(function(){
    $("#intro_collapse").click(function(){
        $("#intro_hidden").toggle(400);
    });
    $("#edu_collapse").click(function(){
        $("#edu_hidden").toggle(400);
        //$("#edu_icon").attr('src', '/assets/edu-icon-active.png');
    });
    $("#work_collapse").click(function(){
        $("#work_hidden").toggle(400);
    });
    $("#hobby_collapse").click(function(){
        $("#hobby_hidden").toggle(400);
    });
    $("#rec_collapse").click(function(){
        $("#rec_hidden").toggle(400);
    });
    $('#push-button').click(function (event) {
        pushVideos();
        event.preventDefault();
    });
});
</script>
